name: Update Submodules and Remove Stale Entries

on:
  workflow_dispatch:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update submodules and remove stale entries
        id: update
        run: |
          set -e
          
          echo "Processing submodules..."
          CHANGES_MADE=false
          STALE_SUBMODULES=""
          
          # Check if .gitmodules exists
          if [ ! -f .gitmodules ]; then
            echo "No .gitmodules file found. Nothing to update."
            exit 0
          fi
          
          # Parse submodules from .gitmodules
          SUBMODULES=$(git config --file .gitmodules --get-regexp path | awk '{ print $2 }')
          
          if [ -z "$SUBMODULES" ]; then
            echo "No submodules configured."
            exit 0
          fi
          
          for SUBMODULE_PATH in $SUBMODULES; do
            echo "----------------------------------------"
            echo "Processing submodule: $SUBMODULE_PATH"
            
            # Get submodule URL
            SUBMODULE_URL=$(git config --file .gitmodules --get "submodule.$SUBMODULE_PATH.url" || echo "")
            
            if [ -z "$SUBMODULE_URL" ]; then
              echo "Warning: No URL found for submodule $SUBMODULE_PATH"
              continue
            fi
            
            echo "URL: $SUBMODULE_URL"
            
            # Check if remote is accessible using git ls-remote
            if git ls-remote --exit-code "$SUBMODULE_URL" HEAD >/dev/null 2>&1; then
              echo "✓ Remote is accessible"
              
              # Get the branch for this submodule (defaults to checking remote HEAD)
              SUBMODULE_BRANCH=$(git config --file .gitmodules --get "submodule.$SUBMODULE_PATH.branch" || echo "")
              
              # Update the submodule to latest commit on tracked branch
              cd "$SUBMODULE_PATH"
              
              if [ -n "$SUBMODULE_BRANCH" ]; then
                echo "Updating to latest commit on branch: $SUBMODULE_BRANCH"
                git fetch origin "$SUBMODULE_BRANCH"
                git checkout "$SUBMODULE_BRANCH"
                git pull origin "$SUBMODULE_BRANCH"
              else
                echo "Updating to latest commit on default branch"
                git fetch origin
                git checkout "$(git rev-parse HEAD)"
                git pull origin HEAD || true
              fi
              
              cd ..
              
              # Check if submodule commit changed
              if git diff --quiet HEAD -- "$SUBMODULE_PATH"; then
                echo "No changes in $SUBMODULE_PATH"
              else
                echo "✓ Updated $SUBMODULE_PATH to latest commit"
                git add "$SUBMODULE_PATH"
                CHANGES_MADE=true
              fi
            else
              echo "✗ Remote is not accessible or empty"
              echo "Marking submodule $SUBMODULE_PATH for removal..."
              STALE_SUBMODULES="$STALE_SUBMODULES $SUBMODULE_PATH"
            fi
          done
          
          # Remove stale submodules
          if [ -n "$STALE_SUBMODULES" ]; then
            echo "----------------------------------------"
            echo "Removing stale submodules..."
            for SUBMODULE_PATH in $STALE_SUBMODULES; do
              echo "Removing stale submodule: $SUBMODULE_PATH"
              
              # Remove from .gitmodules
              git config --file .gitmodules --remove-section "submodule.$SUBMODULE_PATH" 2>/dev/null || true
              
              # Stage .gitmodules changes
              git add .gitmodules
              
              # Remove from .git/config
              git submodule deinit -f "$SUBMODULE_PATH" 2>/dev/null || true
              
              # Remove from working tree and index
              git rm -f "$SUBMODULE_PATH" 2>/dev/null || true
              
              # Remove leftover .git directory if it exists
              rm -rf ".git/modules/$SUBMODULE_PATH" 2>/dev/null || true
              
              CHANGES_MADE=true
            done
          fi
          
          # Output result
          if [ "$CHANGES_MADE" = true ]; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "----------------------------------------"
            echo "✓ Changes detected and staged"
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "----------------------------------------"
            echo "No changes needed"
          fi

      - name: Commit and push changes
        if: steps.update.outputs.changes_made == 'true'
        run: |
          # Check if there are staged changes
          if git diff --staged --quiet; then
            echo "No staged changes to commit"
            exit 0
          fi
          
          # Create commit message
          COMMIT_MSG="chore: update submodules to latest commits"
          
          # Add info about removed submodules if any
          REMOVED=$(git diff --staged --name-only | grep -E "^\.gitmodules$" || echo "")
          if [ -n "$REMOVED" ]; then
            COMMIT_MSG="$COMMIT_MSG and remove stale entries"
          fi
          
          git commit -m "$COMMIT_MSG" -m "Automated update by GitHub Actions"
          git push origin ${{ github.ref_name }}
          
          echo "✓ Changes committed and pushed successfully"

      - name: Summary
        run: |
          if [ "${{ steps.update.outputs.changes_made }}" = "true" ]; then
            echo "### ✅ Submodules Updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Submodules have been updated to their latest commits." >> $GITHUB_STEP_SUMMARY
            echo "Changes have been committed and pushed to the repository." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ℹ️ No Updates Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All submodules are already up to date." >> $GITHUB_STEP_SUMMARY
          fi
